<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="/static/favicon.ico">

    <title>{{.title}}</title>
    <meta name="description" content="{{.description}}"/>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>


    <script src="/static/nacl.min.js"></script>
    <script src="/static/nacl-util.min.js"></script>
    <script src="/static/scrypt-async.min.js"></script>
</head>
<body>
<br/>
<h4 class="text-secondary text-center">{{.header}}</h4>
<div class="container border border-primary">
    <br/>
    {{/* new message */}}
    <div class="form-group d-none" id="inputMessageBlock">
        <label for="message" class="text-secondary">{{.enterTextMessage}}</label>
        <textarea class="form-control mb-3" id="message" rows="4" maxlength="262144" autofocus></textarea>
        <div class="container">
            <div class="row"> {{/* password */}}
                <div class="input-group input-group-sm mb-2 collapse" id="passwordBlock">
                    <div class="input-group-prepend">
                        <span class="input-group-text">{{.password}}</span>
                    </div>
                    <input type="text" class="form-control" id="password"
                           placeholder="{{.passwordEncodePlaceholder}}">
                </div>
            </div>
            <div class="row">
                <div class="input-group d-flex justify-content-center">
                    <button type="button" class="btn btn-danger btn-sm" data-toggle="collapse"
                            data-target="#passwordBlock">Has≈Ço
                    </button>&nbsp;
                    <button type="button" class="btn btn-primary btn-sm" id="encodeButton"
                            onclick="encrypt.processEncode();">{{.secureButton}}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{/* final link */}}
    <div class="form-group d-none" id="linkBlock">
        <label for="link" class="text-secondary">{{.copyLink}}</label>
        <textarea class="form-control" id="link" rows="1"></textarea>
        <br/>
        <div class="container">
            <div class="row">
                <div class="col-sm">
                    <button type="button" class="btn btn-warning btn-block" data-clipboard-action="copy"
                            data-clipboard-target="#link">{{.copyLinkButton}}
                    </button>
                </div>
                <div class="col-sm-1">&nbsp;</div>
                <div class="col-sm">
                    <button type="button" class="btn btn-primary btn-block"
                            onclick="again();">{{.newMessageButton}}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{/* decoded message */}}
    <div class="form-group d-none" id="presentationBlock">
        <div class="container">
            <div class="row">
                <div class="col-sm text-secondary">
                    <p class="text-center">{{.decodedMessage}}:</p>
                    <div class="border-top my-3"></div>
                    <p id="decodedMessage"></p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <button type="button" class="btn btn-primary btn-block"
                            onclick="again();">{{.newMessageButton}}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {{/* decode splash screen */}}
    <div class="form-group d-none" id="decodeBlock">
        <div class="container">
            <div class="row d-none" id="errorForDecodedMessage">
                <div class="col-sm">
                    <p class="text-secondary">{{.messageRead}}
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="input-group input-group-sm mb-2" id="decryptPasswordBlock">
                    <div class="input-group-prepend">
                        <span class="input-group-text">{{.password}}</span>
                    </div>
                    <input type="text" class="form-control" id="decryptPassword"
                           placeholder="{{.passwordDecodePlaceholder}}">
                </div>
            </div>
            <div class="row">
                <div class="col-sm" id="decodeButtonBlock">
                    <button type="button" class="btn btn-warning btn-block"
                            id="decodeButton"{{/* onclick="processDecode();"*/}}>{{.readMessageButton}}
                    </button>
                </div>
                <div class="col-sm-1" id="decodedSpaceBlock">&nbsp;</div>
                <div class="col-sm">
                    <button type="button" class="btn btn-primary btn-block"
                            onclick="again();">{{.newMessageButton}}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<br/>

<div class="container ">
    <div class="row">
        <div class="col-sm-2">
        </div>
        <div class="col">
            <hr>
        </div>
        <div class="col-auto text-secondary"><small>{{.infoHeader}}</small></div>
        <div class="col">
            <hr>
        </div>
        <div class="col-sm-2">
        </div>
    </div>
    <div class="row">
        <div class="col-sm-2">
        </div>
        <div class="col-sm-8">
            <p class="text-secondary">
                <small>{{.info}} <a href="https://github.com/blunext/obliviate" target="_blank">GitHub</a>.</small>
            </p>
        </div>
        <div class="col-sm-2">
        </div>
    </div>
</div>

</body>

<script type="text/javascript">
    'use strict';
    const encrypt = {
        secretKey: '',
        message: '',
        salt: '',
        password: false,
        time: 0,
        processEncode: function () {
            if ($("#passwordBlock").hasClass("collapsing")) {
                return;
            }
            encrypt.message = $('#message').val();
            if (encrypt.message.length === 0) {
                $("#message").addClass('is-invalid');
                return;
            }
            $("#message").removeClass('is-invalid');

            if ($("#passwordBlock").hasClass("show")) {
                const password = $('#password').val();
                if (password.length > 0) {
                    encrypt.password = true;
                    encrypt.salt = nacl.randomBytes(nacl.secretbox.keyLength); // the same as key, 32 bytes
                    calculateKeyDerived(password, encrypt.salt, scryptLogN, encrypt.scryptCallback);
                    $('#password').removeClass('is-invalid');
                } else {
                    $('#password').addClass('is-invalid');
                }
                return;
            }
            encrypt.secretKey = nacl.randomBytes(nacl.secretbox.keyLength);
            encrypt.continue();
        },
        scryptCallback: function (key, time) {
            encrypt.secretKey = key;
            encrypt.time = time;
            encrypt.continue();
        },
        continue: function () {
            // encrypt message with nacl secretbox
            const messageUTF8 = nacl.util.decodeUTF8(encrypt.message);
            const messageNonce = nacl.randomBytes(nacl.secretbox.nonceLength);

            const encryptedMessage = nacl.secretbox(messageUTF8, messageNonce, encrypt.secretKey);

            // nonce will be used as a link anchor
            urlNonce = nacl.util.encodeBase64(messageNonce);

            // store secret key in the message
            const fullMessage = new Uint8Array(encrypt.secretKey.length + encryptedMessage.length);
            if (encrypt.password) {
                fullMessage.set(encrypt.salt);
            } else {
                fullMessage.set(encrypt.secretKey);
            }
            fullMessage.set(encryptedMessage, encrypt.secretKey.length);

            // encrypt message transmission with nacl box
            const transmissionNonce = nacl.randomBytes(nacl.box.nonceLength);
            const transmission = nacl.box(fullMessage, transmissionNonce, serverPublicKey, keys.secretKey);

            const obj = {};
            obj.message = nacl.util.encodeBase64(transmission);
            obj.nonce = nacl.util.encodeBase64(transmissionNonce);
            obj.hash = nacl.util.encodeBase64(nacl.hash(messageNonce));
            obj.publicKey = nacl.util.encodeBase64(keys.publicKey);
            if (encrypt.password) {
                obj.time = encrypt.time;
            }

            $("#encodeButton").addClass('disabled');
            post('POST', obj, '/save', encrypt.encodeSuccess, encrypt.encodeError);
        },
        encodeSuccess: function encodeSuccess(result) {
            let index;
            if (encrypt.password) {
                index = queryIndexWithPassword;
            } else {
                index = 3;
            }
            const url = document.location.origin + '/?' + urlNonce.substring(0, index) + "#" + urlNonce.substring(index, 32);
            $('#link').val(url);
            showLink();
        },
        encodeError: function (XMLHttpRequest, textStatus, errorThrown) {
            alert('{{.encryptError}}');
            $("#encodeButton").removeClass('disabled');
        }
    };

    const decrypt = {
        secretKey: '',
        salt: '',
        encodedMessage: '',
        password: false,
        hash: '',
        loadCypher: function () {
            const nonce = window.location.search.substring(1) + window.location.hash.substring(1);
            urlNonce = nacl.util.decodeBase64(nonce);
            decrypt.hash = nacl.util.encodeBase64(nacl.hash(urlNonce));
            const obj = {};
            obj.hash = decrypt.hash;
            obj.publicKey = nacl.util.encodeBase64(keys.publicKey);
            if (decrypt.password) {
                obj.password = true;
            }

            $("#decodeButton").addClass('disabled');
            post('POST', obj, '/read', decrypt.decryptTransmission, decrypt.loadError);
        },
        decryptTransmission: function (result) {
            // decode transmission with box
            const messageWithNonceAsUint8Array = nacl.util.decodeBase64(result.message);
            const noncePart = arraySlice(messageWithNonceAsUint8Array, 0, nacl.box.nonceLength);
            const messagePart = arraySlice(messageWithNonceAsUint8Array, nacl.box.nonceLength, result.message.length);

            const decrypted = nacl.box.open(messagePart, noncePart, serverPublicKey, keys.secretKey);
            if (!decrypted) {
                $('#decodedMessage').html("{{.generalError}}");
                showDecodedMessage();
                return
            }
            // decode message with secretbox
            if (decrypt.password) {
                decrypt.salt = arraySlice(decrypted, 0, nacl.secretbox.keyLength);
            } else {
                decrypt.secretKey = arraySlice(decrypted, 0, nacl.secretbox.keyLength);
            }
            decrypt.encodedMessage = arraySlice(decrypted, nacl.secretbox.keyLength, decrypted.length);
            decrypt.decryptMessage();
        },
        decryptMessage: function () {
            if (decrypt.password) {
                const password = $('#decryptPassword').val();
                if (password.length > 0) {
                    calculateKeyDerived(password, decrypt.salt, scryptLogN, decrypt.scryptCallback);
                } else {
                    $("#decryptPassword").addClass('is-invalid');
                    $("#decodeButton").removeClass('disabled');
                    decrypt.changeAction();
                }
                return;
            }
            decrypt.continue();
        },
        scryptCallback: function (key, time) { // do nothing with time while decrypt
            decrypt.secretKey = key;
            decrypt.continue();
        },
        continue: function () {
            const messageBytes = nacl.secretbox.open(decrypt.encodedMessage, urlNonce, decrypt.secretKey);
            if (messageBytes == null) {
                if (decrypt.password) {
                    $('#decodedMessage').html("{{.wrongPassword}}");
                    decrypt.changeAction();
                    $("#decodeButton").removeClass('disabled');
                    return;
                }
                $('#decodedMessage').html("{{.generalError}}");
                showDecodedMessage(); // TODO: remove "Decoded message:" header
                return;
            }
            const message = nacl.util.encodeUTF8(messageBytes);

            const escape = document.createElement('textarea');
            escape.textContent = message;
            escape.innerHTML;

            const str = replaceAll(escape.innerHTML, '\n', '<br/>');
            $('#decodedMessage').html(str);
            showDecodedMessage();

            if (decrypt.password){
                const obj = {};
                obj.hash = decrypt.hash;
                post('DELETE', obj, '/delete', decrypt.deleteSuccess, decrypt.deleteError);
            }

        },
        loadError: function (XMLHttpRequest, textStatus, errorThrown) {
            if (XMLHttpRequest.status == 404) {
                $("#decodeButtonBlock").addClass('d-none');
                $("#decodedSpaceBlock").addClass('d-none');
                $("#errorForDecodedMessage").removeClass('d-none');

                $("#decodeButton").removeClass('disabled');
            } else {
                alert('{{.decryptError}}')
                $("#decodeButton").removeClass('disabled');
            }
        },
        changeAction: function () {
            $("#decodeButton").off('click');
            $("#decodeButton").click(function (e) {
                decrypt.decryptMessage();
            });
        },
        deleteSuccess: function () { // do nothing
        },
        deleteError: function (XMLHttpRequest, textStatus, errorThrown) { // do nothing
        }
    };

    // ----- init
    new ClipboardJS('.btn');

    const serverPublicKey = nacl.util.decodeBase64('{{.PublicKey}}');
    let keys = nacl.box.keyPair();
    let urlNonce = '';
    const queryIndexWithPassword = 4;
    const scryptLogN = 14;

    const isMobile = window.matchMedia("only screen and (max-width: 760px)").matches;
    if (isMobile) {
        $("#link").attr('rows', 2);
    }

    if (window.location.hash) {
        decrypt.password = window.location.search.substring(1).length === queryIndexWithPassword;
        showDecodeButton();
    } else {
        showEnterMessage();
    }

    // necessary for .off('click')
    $("#decodeButton").click(function (e) {
        decrypt.loadCypher();
    });

    // -------

    function again() {
        keys = nacl.box.keyPair();
        showEnterMessage();
    }

    function post(method, webObject, url, postSuccess, postError) {
        $.ajax({
            url: url,
            type: method,
            dataType: "json",
            data: JSON.stringify(webObject),
            success: postSuccess,
            error: postError
        });
    }

    function replaceAll(str, find, replace) {
        return str.replace(new RegExp(find, 'g'), replace);
    }

    function arraySlice(arr, x, y) {
        let ret = [];
        for (let i = 0; i < arr.length; i++) {
            if (i >= x && i < y) {
                ret.push(arr[i]);
            }
        }
        return new Uint8Array(ret);
    }

    function calculateKeyDerived(password, salt, logN, callback) {
        window.setTimeout(function () {
            try {
                const t1 = getTime();
                scrypt(password, salt, {
                        logN: logN,
                        r: 8,
                        p: 1,
                        dkLen: nacl.secretbox.keyLength, // 32
                        interruptStep: 0,
                        encoding: 'binary' // hex, base64, binary
                    },
                    function (res) {
                        const time = Math.round(getTime() - t1);
                        callback(res, time);
                    },
                );
            } catch (ex) {
                alert(ex.message); //TODO: process the exception
            }
        });
    }

    var getTime = (function () {
        if (typeof performance !== "undefined") {
            return performance.now.bind(performance);
        }
        return Date.now.bind(Date);
    })();

    //--

    function showEnterMessage() {
        $("#inputMessageBlock").removeClass('d-none');
        $("#linkBlock").addClass('d-none');
        $("#decodeBlock").addClass('d-none');
        $("#presentationBlock").addClass('d-none');

        $("#passwordBlock").removeClass('show');

        $("#message").focus();
        $('#link').val("");
        $('#password').val("");
    }

    function showLink() {
        $("#inputMessageBlock").addClass('d-none');
        $("#linkBlock").removeClass('d-none');
        $("#decodeBlock").addClass('d-none');
        $("#presentationBlock").addClass('d-none');

        $("#message").val("");
        $("#encodeButton").removeClass('disabled');
    }

    function showDecodeButton() {
        if (decrypt.password) {
            $("#decryptPasswordBlock").removeClass('d-none');
        } else {
            $("#decryptPasswordBlock").addClass('d-none');
        }
        $("#inputMessageBlock").addClass('d-none');
        $("#linkBlock").addClass('d-none');
        $("#decodeBlock").removeClass('d-none');
        $("#presentationBlock").addClass('d-none');
    }

    function showDecodedMessage() {
        $("#inputMessageBlock").addClass('d-none');
        $("#linkBlock").addClass('d-none');
        $("#decodeBlock").addClass('d-none');
        $("#presentationBlock").removeClass('d-none');

        $("#decodeButton").removeClass('disabled');
    }

</script>
</html>



